pipeline {
    agent {
        docker {
            image 'node:20-alpine'
            args  '-v /var/run/docker.sock:/var/run/docker.sock'
        }
    }

    options {
        timestamps()
        disableConcurrentBuilds()
        timeout(time: 45, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    environment {
        APP_NAME        = "angular-frontend"
        REGISTRY_USER   = "rupesh1997"
        DOCKER_REGISTRY = "docker.io"
        NOTIFY_EMAIL    = "dulalrupesh77@gmail.com"

        // Credentials IDs
        REGISTRY_CRED   = "dockerhub-creds"
        GITHUB_CRED     = "github-token-push"

        // GitOps Paths
        COMPOSE_PATH    = "docker/docker-compose/production/docker-compose.yaml"
        K8S_PATH        = "kubernetes/frontend.yaml"
    }

    stages {
        stage('üõ†Ô∏è Install & Lint') {
            steps {
                sh "npm install"
                // Fails if there are syntax/style violations
                sh "npm run lint"
            }
        }

        stage('üß™ Quality & Security') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        // Headless Chrome is required for Jenkins CI environments
                        sh "npm test -- --watch=false --browsers=ChromeHeadless"
                    }
                    post {
                        always {
                            junit '**/test-reports/*.xml'
                        }
                    }
                }

                stage('SCA (NPM Audit)') {
                    steps {
                        // Fails build if production vulnerabilities are found
                        sh "npm audit --audit-level=high"
                    }
                }

                stage('SonarQube (SAST)') {
                    steps {
                        script {
                            def scannerHome = tool 'sonar-scanner'
                            withSonarQubeEnv('SonarQube-Server') {
                                sh "${scannerHome}/bin/sonar-scanner -Dsonar.projectKey=${APP_NAME}"
                            }
                        }
                    }
                }
            }
        }

        stage('üèóÔ∏è Production Build') {
            steps {
                // Generates the /dist folder
                sh "npm run build -- --configuration=production"
            }
        }

        stage('üì¶ Containerize & Scan') {
            steps {
                script {
                    // Extract version from package.json
                    env.VERSION = sh(script: "node -p \"require('./package.json').version\"", returnStdout: true).trim()
                    env.FULL_IMAGE_NAME = "${DOCKER_REGISTRY}/${REGISTRY_USER}/${APP_NAME}:${env.VERSION}"

                    // Build image (Assumes Dockerfile uses Nginx to serve /dist)
                    sh "docker build -t ${FULL_IMAGE_NAME} ."

                    // Container Security Scan
                    sh "trivy image --severity HIGH,CRITICAL --exit-code 1 ${FULL_IMAGE_NAME}"
                }
            }
        }

        stage('üöÄ Push & GitOps Update') {
            when { branch 'main' }
            steps {
                script {
                    // 1. Push Image
                    withCredentials([usernamePassword(credentialsId: "${REGISTRY_CRED}", usernameVariable: 'U', passwordVariable: 'P')]) {
                        sh "echo $P | docker login -u $U --password-stdin"
                        sh "docker push ${FULL_IMAGE_NAME}"
                    }

                    // 2. Update Manifests
                    sh "yq -i '.services.frontend-svc.image = \"${FULL_IMAGE_NAME}\"' ${COMPOSE_PATH}"
                    sh "sed -i 's|image: ${REGISTRY_USER}/${APP_NAME}:.*|image: ${FULL_IMAGE_NAME}|g' ${K8S_PATH}"

                    // 3. Git Push
                    withCredentials([usernamePassword(credentialsId: "${GITHUB_CRED}", usernameVariable: 'GU', passwordVariable: 'GT')]) {
                        sh """
                            git config user.name "Jenkins CI"
                            git config user.email "jenkins@example.com"
                            git add ${COMPOSE_PATH} ${K8S_PATH}
                            if ! git diff --staged --quiet; then
                                git commit -m 'chore(ui): update to ${env.VERSION} [skip ci]'
                                git push https://${GU}:${GT}@github.com/${REGISTRY_USER}/your-repo.git HEAD:main
                            fi
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            emailext (
                 to: "${NOTIFY_EMAIL}",
                 subject: "‚úÖ SUCCESS: ${env.JOB_NAME} [Build #${env.BUILD_NUMBER}]",
                 body: """
                    <html>
                    <body style="font-family: Arial, sans-serif;">
                        <h2 style="color: #28a745;">Build Successful</h2>
                        <hr>
                        <p><b>Project:</b> ${env.JOB_NAME}</p>
                        <p><b>Version:</b> ${env.VERSION}</p>
                        <p><b>Build URL:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                        <p><b>Docker Image:</b> <code style="background: #f4f4f4; padding: 2px 5px;">${env.FULL_IMAGE_NAME}</code></p>
                        <br>
                        <p style="color: #555;"><i>This is an automated message from your DevSecOps Pipeline.</i></p>
                    </body>
                    </html>
                 """,
                 mimeType: 'text/html'
            )
        }

            failure {
                emailext (
                    to: "${NOTIFY_EMAIL}",
                    subject: "‚ùå FAILED: ${env.JOB_NAME} [Build #${env.BUILD_NUMBER}]",
                    body: """
                    <html>
                    <body style="font-family: Arial, sans-serif;">
                        <h2 style="color: #d73a49;">Pipeline Failure Alert</h2>
                        <hr>
                        <p>The build failed at stage: <b>${env.STAGE_NAME}</b></p>
                        <p><b>Build URL:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                        <p><b>Console Output:</b> <a href="${env.BUILD_URL}console">View Logs Here</a></p>
                        <p><i>Note: The build log has been compressed and attached to this email for troubleshooting.</i></p>
                    </body>
                    </html>
                    """,
                    mimeType: 'text/html',
                    attachLog: true,     // Attaches the console output
                    compressLog: true    // Zips it (critical for large logs)
                )
            }
        }
}